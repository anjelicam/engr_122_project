---
title: The Relationship Between Air Pollution and Mobility of Individuals Following
  COVID-19 Related Shelter-in-Place Orders
author: "Anjelica Martinez, Joanna Rashid, Yousif Nuaimi"
date: "05/08/2020"
output:
  html_notebook:
    fig_height: 4
    fig_width: 6
    highlight: null
    theme: flatly
  html_document:
    df_print: paged
  pdf_document: default
---

<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>

## Introduction

The historic COVID-19 pandemic has caused nearly 50% of the world population to be subject to government “stay-at-home” and self-isolation orders. This sudden, drastic reduction in the mobility of the population has generated a natural experiment that tests the effect a near halt of mobility for individuals and drastic reduction of commercial operations would have on air quality. The metric used for this study is the mean daily mobility of individuals in a given US county.
  
Based on this criteria, we selected five major counties that had the highest level of mobility reduction as well as five other counties that didn’t have much reduction in mobility. A major county is defined as being in the top 40 most populous counties in the US, per the US Census Bureau. The time period of this study is February 28 through March 27, which is the time during which some US counties enacted “shelter-in-place” and the self-isolation orders to control the community spread of COVID-19.  The five counties with the greatest reduction in citizen mobility issued “shelter-in-place” orders during this period.

The five counties with the least mobility reduction had no “shelter-in-place” orders during the studied time period and can serve as a control group. The finding of this data visualization study will serve to convey the quantity of air pollution generated by the mobility individuals alone.

### Counties of Interest

Counties that decreased mobility 98-100% between Feb. 28 to Mar. 27. (Glanz, J., et al., 2020). New York Times.

* Arlington, VA
* District of Columbia, DC
* New York, NY
* San Francisco, CA
* Santa Clara, CA

Most populous counties that decreased mobility 30% or less between Feb. 28 to Mar. 27. (Glanz, J., et al., 2020). New York Times.

* Miami-Dade, FL
* Dallas, TX
* Harris, TX
* Maricopa, AZ
* San Bernardino County, CA

## Load libraries and data
```{r Libraries, message=FALSE, warning=FALSE}
library(easypackages)
libraries("gridExtra", "viridis", "tidyverse", "plotly", "hrbrthemes", "htmlwidgets", "plotly", "ggpubr", "scales")
```

```{r message=FALSE, warning=FALSE}
load("data/tidy/tidy_mobility_vs_aqi.RData")
```

## Exploratory Data Analyses
First, we took a look at the tidy data sets we prepared before analysis. There are three datasets we will be working with:

* df: dataset containing the AQI, mobility index, and pollutant values for the 10 counties of interest
* high_mobility: dataset with counties decreased mobility 30% or less between Feb. 28 to Mar. 27
* low_mobility: dataset with counties that decreased mobility 98-100% between Feb. 28 to Mar. 27

### Definitions Review
* m50: The median of the max-distance mobility for all samples in the specified region.

* m50_index: The percent of normal m50 in the region, with normal m50 defined during 2020-02-17 to 2020-03-07.

* AQI: average air quality index for that day

* Pollutant names (e.g. Ozone, PM25): each have their average daily value

* main_pollutant: from the original data, represented which pollutant was the main pollutant affecting AQI

```{r Tables, message=FALSE, warning=FALSE, paged.print=TRUE}
head(df)
head(high_mobility)
head(low_mobility)
```

### Time Series Mobility over time
We used a time series plot to get a quick visual overview of the mobility index values (m50_index) of each county from March 1st to April 18th 2020.
```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=12, dpi=300}

# Mobility Time Series Plot
#Counties that decreased mobility 30% or less between Feb. 28 to Mar. 27
high_mobility_plot <- ggplot(high_mobility, aes(x = date, y = m50_index, fill = county)) +
                       geom_area() +
                       scale_fill_viridis(discrete = TRUE) +
                       theme(legend.position = "none") +
                       labs(
                         title = "High Mobility",
                         x = "Date",
                         y = "Mobility Index") +
                       scale_x_date(date_labels = "%b %d", date_breaks = "1 week") +
                       scale_y_continuous(breaks = seq(0, 200, by = 20)) +
                       theme_ipsum() +
                       theme(
                             legend.position = "none",
                             panel.spacing = unit(0, "lines"),
                             strip.text.x = element_text(size = 10),
                             plot.title = element_text(size = 13)) +
                       facet_wrap(county ~ ., ncol = 1)

# Mobility Time Series Plot
# Counties that decreased mobility 98-100% between Feb. 28 to Mar. 27
low_mobility_plot <- ggplot(low_mobility, aes(x = date, y = m50_index, fill = county)) +
                       geom_area() +
                       scale_fill_viridis(discrete = TRUE) +
                       theme(legend.position = "none") +
                       labs(title = "Low Mobility", x = "Date", y = "Mobility Index") +
                       scale_x_date(date_labels = "%b %d", date_breaks = "1 week") +
                       scale_y_continuous(breaks = seq(0, 200, by = 20)) +
                       theme_ipsum() +
                       theme(
                             legend.position = "none",
                             panel.spacing = unit(0, "lines"),
                             strip.text.x = element_text(size = 10),
                             plot.title = element_text(size = 13)) +
                       facet_wrap(county ~ ., ncol = 1)

grid.arrange(low_mobility_plot, high_mobility_plot, ncol = 2)
```

### Daily Air Quality Index Values from March 1 to April 18

```{r message=FALSE, warning=FALSE, fig.width=15, fig.height=12, dpi=300}
high_mobility_aqi <- ggplot(high_mobility, aes(x = date, y = aqi, fill = county)) +
                       geom_area() +
                       scale_fill_viridis(discrete = TRUE) +
                       theme(legend.position = "none") +
                       labs(title = "AQI of Counties with High Mobility", x = "Date", y = "Air Quality Index") +
                       scale_x_date(date_labels = "%b %d") +
                       scale_y_continuous(breaks = seq(0, 60, by = 10)) +
                       theme_ipsum() +
                         theme(
                           legend.position = "none",
                           panel.spacing = unit(0, "lines"),
                           strip.text.x = element_text(size = 8),
                           plot.title = element_text(size = 13)) +
                       facet_wrap(county ~ ., ncol = 1)

low_mobility_aqi <- ggplot(high_mobility, aes(x = date, y = aqi, fill = county)) +
                     geom_area() +
                     scale_fill_viridis(discrete = TRUE) +
                     theme(legend.position = "none") +
                     labs(title = "AQI of counties with Low Mobility", x = "Date", y = "Air Quality Index") +
                     scale_x_date(date_labels = "%b %d") +
                     scale_y_continuous(breaks = seq(0, 60, by = 10)) +
                     theme_ipsum() +
                     theme(
                       legend.position = "none",
                       panel.spacing = unit(0, "lines"),
                       strip.text.x = element_text(size = 8),
                       plot.title = element_text(size = 13)) +
                     facet_wrap(county ~ ., ncol = 1)

grid.arrange(high_mobility_aqi, low_mobility_aqi, ncol = 2)

```

### AQI vs. Mobility for Each County

### Correlation Scatterplot
Ran this to see corr. coef, and p-value, and visually see the data
```{r message=FALSE, fig.asp = .3, fig.width= 20}
# All Counties

ggscatter(df, x = "aqi", y = "m50_index", 
          add = "reg.line", 
          conf.int = TRUE, 
          cor.coef = TRUE, 
          cor.method = "pearson",
          xlab = "Air Quality Index", 
          ylab = "Mobility Index",
          add.params = list(color = "blue",
                            fill = "lightgray")) +
          facet_wrap(~county, ncol = 5, scales = "free_x")
```

### Pearson's Product Moment Correlation test for each county to see significance and strength of relationship

```{r message=FALSE, warning=FALSE}
results = list() # Prep a list to store your corr.test results
counter = 0 # To store your corr.test into list through iterating

for (i in unique(df$county))
{
  counter = counter + 1
  # Creates x and y values for cor.test()
  x = as.numeric(df[df$county == i,]$aqi)
  y = as.numeric(df[df$county == i,]$m50_index)
  
  results[[i]] <- cor.test(x, y, method = "pearson") # correlation test
}
results
```
## Interpretation
Based on these data the counties with significant p-values are Harris (p = .02), Maricopa (p > .001), and New York (p = .01). The other counties did not have significant p-values and no conclusions can be made.

### Double Y-Axis Plot Time Series of Mobility vs AQI for counties with significant p-values
```{r message=FALSE, warning=FALSE, fig.asp=.3, fig.width=13}
# Significant Counties dataframe
sig_counties_values <- filter(df, county %in% c("Harris", "Maricopa", "New York")) %>% select(date, county, aqi, m50_index)

# Color values
aqi_color <- "#69b3a2"
mobility_color <- rgb(0.2, 0.6, 0.9, 1)

# Significant Counties Double y-axis Plot
ggplot(sig_counties_values, aes(x = date)) +
  geom_line(aes(y = aqi), size = 1, color = aqi_color) + 
  geom_line(aes(y = m50_index), size = 1, color = mobility_color) +
  xlab("Date") +
  scale_y_continuous(
    name = "Air Quality Index",
    sec.axis = sec_axis(~ ., name = "Mobility Index")) + 
  facet_wrap(~county, ncol = 3) +
  theme_ipsum() +
  theme(
    axis.title.y = element_text(color = aqi_color, size = 13),
    axis.title.y.right = element_text(color = mobility_color, size = 13)) +
  ggtitle("Mobility Decreased, Air Quality Increase")
```

```{r message=FALSE, warning=FALSE, fig.asp = .3, fig.width= 15}
ggscatter(sig_counties_values, x = "aqi", y = "m50_index", 
          add = "reg.line", conf.int = TRUE, 
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Air Quality Index", ylab = "Mobility Index") +
  facet_wrap(~county, ncol = 3)
```

## Conclusion

The COVID-19 crisis has resulted in extensive "shelter-in-place" orders worldwide in order to reduce transmission of the virus. There is speculation whether the decrease in pollution (improvement of Air Quality) is related to the decrease in vehicle commuting. We wanted to run the data and find whether reduction in mobility may be a factor in improvement of Air Quality.

We hypothesized that there would be a statistically significant relationship between air quality and mobility. Our data results show that there is a strong negative correlation between mobility and air quality for Harris County (r = -0.35, p = .016), Maricopa County (r = -0.35, p = .016), and New York County (r = -0.35, p = .016). The other counties do not have significant p-values and no conclusions can be drawn on the relationship between mobility and air quality.

We only focused on the 10 counties reported in the news article, however it would be interesting to analyze all counties across the United States, air quality levels, and mobility information. An additional factor that would be interesting to observe would be the effects of industrial pollutant output levels and whether they have had any influence on general air quality during the pandemic.